<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planicchio: Impara l'Italiano ğŸ‡®ğŸ‡¹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #FFF5EB; padding-bottom: 80px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .xp-header { background: white; border-bottom: 2px solid #FF8C00; position: sticky; top: 0; z-index: 50; }
        
        /* Cores de Categoria */
        .cat-slang { border-left: 6px solid #FF8C00; }
        .cat-grammar { border-left: 6px solid #3B82F6; }
        .cat-culture { border-left: 6px solid #8B5CF6; }
        
        .badge { font-size: 10px; padding: 2px 8px; border-radius: 20px; text-transform: uppercase; font-weight: bold; }
        .bg-slang { background: #FFEDD5; color: #9A3412; }
        .bg-grammar { background: #DBEAFE; color: #1E40AF; }
        .bg-culture { background: #F3E8FF; color: #6B21A8; }

        .mission-card { background: #FFF; border: 1px dashed #FF8C00; border-radius: 10px; padding: 10px; margin-bottom: 10px; }
        
        /* Efeito de GravaÃ§Ã£o */
        .recording { animation: pulse-red 1s infinite; color: red !important; }
        @keyframes pulse-red { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .btn-premium { background: linear-gradient(45deg, #FF8C00, #FF4500); color: white; font-weight: bold; border-radius: 15px; }
    </style>
</head>
<body class="p-4">

    <div class="xp-header p-3 mb-6 shadow-sm rounded-b-2xl">
        <div class="flex justify-between items-center mb-2">
            <span class="font-black text-orange-600">PLANICCHIO ğŸ‡®ğŸ‡¹</span>
            <div class="text-right">
                <span class="text-xs font-bold text-gray-500">LIVELLO <span id="lvl">1</span></span>
                <div class="w-24 h-2 bg-gray-200 rounded-full"><div id="xp-bar" class="h-full bg-orange-500 rounded-full" style="width: 0%"></div></div>
            </div>
        </div>
        
        <div class="mission-card">
            <p class="text-[10px] font-bold text-orange-700 uppercase mb-1">ğŸ¯ Missioni Giornaliere</p>
            <div class="flex justify-between items-center text-xs">
                <span id="m1">0/1 Quiz Completato</span>
                <span id="xp-display" class="font-bold text-orange-600">+0 XP</span>
            </div>
        </div>
    </div>

    <div class="bg-black text-white p-4 rounded-2xl mb-6 shadow-xl">
        <p class="text-orange-400 text-[10px] font-bold uppercase mb-2">ğŸ¬ Sfida d'ascolto (Audio Challenge)</p>
        <p class="text-sm italic mb-3">Ascolta e scrivi cosa hai capito:</p>
        <input type="text" id="dictation-input" placeholder="Scrivi qui..." class="w-full p-2 rounded bg-gray-800 text-white text-sm border border-gray-600 focus:border-orange-500 outline-none">
        <button onclick="checkDictation()" class="mt-2 w-full bg-orange-500 py-1 rounded font-bold text-xs">CONTROLLA</button>
    </div>

    <div id="quiz-box" class="bg-white p-5 rounded-2xl border-2 border-orange-500 mb-8 shadow-lg">
        <p id="q-txt" class="font-bold text-lg text-gray-800 mb-4 italic">Caricamento...</p>
        <div id="q-options" class="space-y-3"></div>
    </div>

    <h2 class="text-xl font-black text-gray-800 mb-4 border-l-4 border-orange-500 pl-2">VOCABOLARIO & CULTURA</h2>
    <div id="slang-list" class="space-y-4"></div>

    <script>
        // CONFIGURAÃ‡ÃƒO
        const fone = "393716755981";
        const LINK_EX = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT6-Ah6rq3hnBihlxVAzmsTD8rEF1rbGJu3__sBgm-DDyFWE_D7sxgJx3I3s55uiNl-qvP2x2wh0UD9/pub?gid=633031910&single=true&output=csv';
        const LINK_SL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT6-Ah6rq3hnBihlxVAzmsTD8rEF1rbGJu3__sBgm-DDyFWE_D7sxgJx3I3s55uiNl-qvP2x2wh0UD9/pub?gid=541320303&single=true&output=csv';

        let xp = parseInt(localStorage.getItem('planicchio_xp')) || 0;
        let exercicios = [];
        let indexQ = 0;
        let mediaRecorder;
        let chunks = [];

        // SISTEMA DE SOM E GRAVAÃ‡ÃƒO
        function playSfx(type) {
            const url = type === 'ok' ? 'https://www.soundjay.com/buttons/sounds/button-37.mp3' : 'https://www.soundjay.com/buttons/sounds/button-10.mp3';
            new Audio(url).play().catch(()=>{});
        }

        async function startRec(btn) {
            if (!mediaRecorder || mediaRecorder.state === "inactive") {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = e => chunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'audio/ogg' });
                    new Audio(URL.createObjectURL(blob)).play();
                    chunks = [];
                };
                mediaRecorder.start();
                btn.classList.add('recording');
                setTimeout(() => { if(mediaRecorder.state === "recording") stopRec(btn); }, 3000);
            } else { stopRec(btn); }
        }
        function stopRec(btn) { mediaRecorder.stop(); btn.classList.remove('recording'); }

        // CARREGAR DADOS
        async function load() {
            updateXP(0);
            try {
                const res = await fetch(LINK_EX);
                const data = await res.text();
                exercicios = data.split(/\r?\n/).slice(1).map(r => {
                    const c = r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    return { q: clean(c[1]), a: clean(c[2]), b: clean(c[3]), c: clean(c[4]), ok: clean(c[5]).toLowerCase() };
                });
                renderQuiz();

                const res2 = await fetch(LINK_SL);
                const data2 = await res2.text();
                const container = document.getElementById('slang-list');
                container.innerHTML = "";
                data2.split(/\r?\n/).slice(1).forEach((r, i) => {
                    const c = r.split(/,(?=(?:(?:[^!]*"){2})*[^"]*$)/);
                    if (clean(c[2])) {
                        const isLocked = i > 6;
                        const cat = i % 2 === 0 ? 'slang' : 'culture'; // Simulando categorias
                        const div = document.createElement('div');
                        div.className = `bg-white p-4 rounded-xl shadow-sm cat-${cat} ${isLocked ? 'opacity-30 grayscale' : ''}`;
                        div.innerHTML = `
                            <div class="flex justify-between items-center mb-2">
                                <span class="badge bg-${cat}">${cat}</span>
                                <div class="flex gap-4">
                                    ${!isLocked ? `<button onclick="playSfx('ok')">ğŸ”Š</button><button onclick="startRec(this)">ğŸ™ï¸</button>` : 'ğŸ”’'}
                                </div>
                            </div>
                            <h3 class="font-bold text-orange-600">${clean(c[2])}</h3>
                            <p class="text-[10px] text-gray-400 font-bold">ğŸ‡§ğŸ‡· TRADUÃ‡ÃƒO: ${clean(c[3])}</p>
                            <p class="text-sm text-gray-700 my-2">${isLocked ? 'Sblocca nel VIP' : clean(c[4])}</p>
                            <div class="text-[10px] bg-orange-50 p-2 rounded border-l-2 border-orange-200 italic">
                                ğŸ’¡ <b>Dica:</b> No interior da ItÃ¡lia usa-se muito...
                            </div>
                        `;
                        container.appendChild(div);
                    }
                });
            } catch(e) {}
        }

        function renderQuiz() {
            const item = exercicios[indexQ];
            document.getElementById('q-txt').innerText = item.q;
            const opt = document.getElementById('q-options');
            opt.innerHTML = "";
            ['a','b','c'].forEach(l => {
                const b = document.createElement('button');
                b.className = "w-full text-left p-3 border-2 border-orange-200 rounded-xl font-bold text-orange-700 text-sm";
                b.innerText = item[l];
                b.onclick = () => {
                    if (l === item.ok) {
                        playSfx('ok'); updateXP(20);
                        b.style.background = "#dcfce7";
                        setTimeout(() => { indexQ++; renderQuiz(); }, 1000);
                    } else {
                        playSfx('err'); b.style.background = "#fee2e2";
                    }
                };
                opt.appendChild(b);
            });
        }

        function updateXP(val) {
            xp += val;
            localStorage.setItem('planicchio_xp', xp);
            document.getElementById('xp-display').innerText = `+${xp} XP`;
            document.getElementById('xp-bar').style.width = (xp % 100) + "%";
            document.getElementById('lvl').innerText = Math.floor(xp / 100) + 1;
            if (xp > 50) document.getElementById('m1').innerHTML = "âœ… Quiz Completato";
        }

        function clean(t) { return t ? t.replace(/"/g, '').trim() : ""; }
        load();
    </script>
</body>
</html>
